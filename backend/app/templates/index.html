{% extends "base.html" %}

{% block title %}Find Jobs - Texas Ed Jobs{% endblock %}

{% block main_class %}flex-grow{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    /* Map + list split layout */
    .split-container {
        height: calc(100vh - 64px - 52px); /* navbar + filter bar */
    }
    #job-panel {
        overflow-y: auto;
        scrollbar-width: thin;
    }
    #job-panel::-webkit-scrollbar {
        width: 6px;
    }
    #job-panel::-webkit-scrollbar-thumb {
        background: oklch(var(--bc) / 0.2);
        border-radius: 3px;
    }

    /* Leaflet popup styles */
    .leaflet-popup-content {
        min-width: 200px;
        max-width: 280px;
        margin: 8px 12px;
    }
    .job-popup-title {
        font-weight: 600;
        font-size: 0.875rem;
        line-height: 1.3;
        margin-bottom: 4px;
    }
    .job-popup-org {
        color: oklch(var(--bc) / 0.6);
        font-size: 0.75rem;
        margin-bottom: 6px;
    }
    .job-popup-meta {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        margin-bottom: 8px;
    }
    .job-popup-badge {
        font-size: 0.625rem;
        padding: 1px 6px;
        border-radius: 9999px;
        background: oklch(var(--p) / 0.1);
        color: oklch(var(--p));
    }
    .job-popup-link {
        display: inline-block;
        background: oklch(var(--p));
        color: oklch(var(--pc));
        padding: 4px 12px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .job-popup-link:hover {
        opacity: 0.9;
    }

    /* Marker cluster colors */
    .marker-cluster-small {
        background-color: rgba(110, 204, 57, 0.6);
    }
    .marker-cluster-small div {
        background-color: rgba(110, 204, 57, 0.9);
    }
    .marker-cluster-medium {
        background-color: rgba(240, 194, 12, 0.6);
    }
    .marker-cluster-medium div {
        background-color: rgba(240, 194, 12, 0.9);
    }
    .marker-cluster-large {
        background-color: rgba(241, 128, 23, 0.6);
    }
    .marker-cluster-large div {
        background-color: rgba(241, 128, 23, 0.9);
    }

    /* Loading overlay on map */
    .map-loading-overlay {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 1000;
        background: oklch(var(--b1));
        border-radius: 8px;
        padding: 6px 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Mobile floating toggle */
    .mobile-toggle {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1100;
    }

    /* Hide footer in map mode on desktop to maximize space */
    @media (min-width: 1024px) {
        [data-mode="map"] footer { display: none; }
    }

    /* ISD search dropdown */
    .org-dropdown {
        position: relative;
    }
    .org-dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1200;
        background: oklch(var(--b1));
        border: 1px solid oklch(var(--bc) / 0.2);
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        width: 280px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        scrollbar-width: thin;
    }
    .org-dropdown-list button {
        display: block;
        width: 100%;
        text-align: left;
        padding: 6px 12px;
        font-size: 0.8125rem;
        border: none;
        background: none;
        cursor: pointer;
    }
    .org-dropdown-list button:hover {
        background: oklch(var(--p) / 0.1);
    }
    .org-dropdown-list button.active {
        background: oklch(var(--p) / 0.15);
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="jobSearch()" x-init="init()" :data-mode="mode"
     @jobs-loaded.window="onJobsLoaded($event.detail)"
     @click.away="orgDropdownOpen = false"
     class="flex flex-col">

    <!-- Filter bar -->
    <div class="bg-base-100 border-b border-base-200 px-3 py-2 flex flex-wrap items-center gap-2">
        <!-- Search input -->
        <input type="text"
               x-model="filters.search"
               @input.debounce.400ms="onFilterChange()"
               placeholder="Search jobs..."
               class="input input-bordered input-sm w-40 lg:w-48">

        <!-- Category dropdown -->
        <select x-model="filters.category"
                @change="onFilterChange()"
                class="select select-bordered select-sm w-36 lg:w-40">
            <option value="">All Categories</option>
            {% for cat in categories %}
            <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
        </select>

        <!-- ISD / Organization searchable dropdown -->
        <div class="org-dropdown" @click.away="orgDropdownOpen = false">
            <input type="text"
                   x-model="orgSearchText"
                   @focus="orgDropdownOpen = true"
                   @input.debounce.200ms="orgDropdownOpen = true"
                   :placeholder="selectedOrgName || 'District...'"
                   :class="filters.organization_id ? 'input-primary' : ''"
                   class="input input-bordered input-sm w-36 lg:w-48">
            <div x-show="orgDropdownOpen" x-transition class="org-dropdown-list">
                <button @click="selectOrg('', ''); orgDropdownOpen = false"
                        :class="!filters.organization_id && 'active'">
                    All Districts
                </button>
                <template x-for="org in filteredOrgs" :key="org.id">
                    <button @click="selectOrg(org.id, org.name, org.tea_id); orgDropdownOpen = false"
                            :class="filters.organization_id === org.id && 'active'"
                            x-text="org.name">
                    </button>
                </template>
            </div>
        </div>

        <!-- City input -->
        <input type="text"
               x-model="filters.city"
               @input.debounce.400ms="onFilterChange()"
               placeholder="City..."
               class="input input-bordered input-sm w-28 lg:w-36">

        <!-- Platform dropdown -->
        <select x-model="filters.platform"
                @change="onFilterChange()"
                class="select select-bordered select-sm w-36 lg:w-40">
            <option value="">All Platforms</option>
            {% for plat in platforms %}
            <option value="{{ plat }}">{{ plat }}</option>
            {% endfor %}
        </select>

        <!-- Clear filters -->
        <button @click="clearFilters()"
                x-show="filters.search || filters.category || filters.city || filters.platform || filters.organization_id"
                class="btn btn-ghost btn-xs">
            Clear
        </button>

        <!-- Districts toggle (map mode only) -->
        <button @click="toggleBoundaries()"
                x-show="mode === 'map'"
                :class="boundariesVisible ? 'btn-primary' : 'btn-ghost'"
                class="btn btn-xs gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
            Districts
        </button>

        <!-- Near Me (map mode only) -->
        <button @click="locateMe()"
                x-show="mode === 'map'"
                class="btn btn-ghost btn-xs gap-1"
                :class="locating && 'loading'">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" x-show="!locating">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Near Me
        </button>

        <!-- Spacer -->
        <div class="flex-1"></div>

        <!-- Job count -->
        <span class="text-xs text-base-content/50 hidden sm:inline" x-text="jobCountText"></span>

        <!-- Mode toggle -->
        <div class="join">
            <button @click="setMode('list')"
                    :class="mode === 'list' ? 'btn-primary' : 'btn-ghost'"
                    class="btn btn-xs join-item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                </svg>
                List
            </button>
            <button @click="setMode('map')"
                    :class="mode === 'map' ? 'btn-primary' : 'btn-ghost'"
                    class="btn btn-xs join-item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                </svg>
                Map
            </button>
        </div>
    </div>

    <!-- Split container -->
    <div class="split-container flex" :class="mode === 'list' ? 'flex-col' : ''">
        <!-- Job list panel -->
        <div id="job-panel"
             :class="mode === 'map'
                 ? 'w-[420px] shrink-0 border-r border-base-200 p-3 hidden lg:block'
                 : 'flex-1 max-w-5xl mx-auto w-full p-4 lg:p-6'"
             :style="mode === 'map' ? 'height: 100%' : ''">

            <!-- Loading spinner (initial) -->
            <div x-show="loading" class="flex justify-center py-12">
                <span class="loading loading-spinner loading-md text-primary"></span>
            </div>

            <!-- Job list content (HTMX target) -->
            <div id="job-list-content" x-show="!loading"></div>
        </div>

        <!-- Map panel -->
        <div x-show="mode === 'map'"
             class="flex-1 relative"
             x-transition:enter="transition-opacity duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100">
            <div id="map" class="w-full h-full"></div>

            <!-- Map loading overlay -->
            <div x-show="markersLoading" class="map-loading-overlay">
                <span class="loading loading-spinner loading-xs"></span>
                Loading markers...
            </div>
        </div>
    </div>

    <!-- Mobile floating toggle (< lg only, map mode) -->
    <div class="mobile-toggle lg:hidden" x-show="mode === 'map'">
        <button @click="setMode('list')"
                class="btn btn-primary btn-sm shadow-lg gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
            Show List (<span x-text="shownCount"></span>)
        </button>
    </div>
    <div class="mobile-toggle lg:hidden" x-show="mode === 'list'">
        <button @click="setMode('map')"
                class="btn btn-primary btn-sm shadow-lg gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
            Show Map
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
// Organization data for ISD filter dropdown (passed from backend)
const ALL_ORGS = {{ organizations | tojson }};

function jobSearch() {
    return {
        mode: 'map',
        filters: { search: '', category: '', city: '', platform: '', organization_id: '' },
        bounds: null,
        mapCenter: { lat: 31.0, lng: -100.0, zoom: 6 },
        loading: true,
        markersLoading: false,
        locating: false,
        shownCount: 0,
        totalCount: {{ total_jobs }},
        fetchId: 0,
        map: null,
        markerCluster: null,
        markersFilterKey: '',
        popupCache: new Map(),
        _moveendTimer: null,

        // Boundary layer state
        boundaryLayer: null,
        boundaryData: null,
        boundariesVisible: false,
        _highlightedTeaId: null,

        // Org dropdown state
        orgDropdownOpen: false,
        orgSearchText: '',
        selectedOrgName: '',

        get filteredOrgs() {
            const q = this.orgSearchText.toLowerCase().trim();
            if (!q) return ALL_ORGS;
            return ALL_ORGS.filter(o => o.name.toLowerCase().includes(q));
        },

        get jobCountText() {
            if (this.mode === 'map') {
                return `${this.shownCount} of ${this.totalCount} jobs`;
            }
            return `${this.totalCount} jobs`;
        },

        _currentFilterKey() {
            return [
                this.filters.search,
                this.filters.category,
                this.filters.city,
                this.filters.platform,
                this.filters.organization_id
            ].join('|');
        },

        init() {
            this.readURL();

            this.$nextTick(() => {
                if (this.mode === 'map') {
                    this.initMap();
                } else {
                    this.fetchJobs();
                }
            });
        },

        readURL() {
            const params = new URLSearchParams(window.location.search);
            this.mode = params.get('mode') || 'map';
            this.filters.search = params.get('search') || '';
            this.filters.category = params.get('category') || '';
            this.filters.city = params.get('city') || '';
            this.filters.platform = params.get('platform') || '';
            this.filters.organization_id = params.get('organization_id') || '';

            // Restore org name from URL
            if (this.filters.organization_id) {
                const org = ALL_ORGS.find(o => o.id === this.filters.organization_id);
                if (org) {
                    this.selectedOrgName = org.name;
                    this.orgSearchText = '';
                }
            }

            if (params.get('lat') && params.get('lng') && params.get('z')) {
                this.mapCenter = {
                    lat: parseFloat(params.get('lat')),
                    lng: parseFloat(params.get('lng')),
                    zoom: parseInt(params.get('z'))
                };
            }
        },

        syncToURL() {
            const params = new URLSearchParams();
            params.set('mode', this.mode);
            if (this.filters.search) params.set('search', this.filters.search);
            if (this.filters.category) params.set('category', this.filters.category);
            if (this.filters.city) params.set('city', this.filters.city);
            if (this.filters.platform) params.set('platform', this.filters.platform);
            if (this.filters.organization_id) params.set('organization_id', this.filters.organization_id);

            if (this.mode === 'map' && this.map) {
                const c = this.map.getCenter();
                params.set('lat', c.lat.toFixed(4));
                params.set('lng', c.lng.toFixed(4));
                params.set('z', this.map.getZoom());
            }

            history.replaceState(null, '', '?' + params.toString());
        },

        initMap() {
            if (this.map) return;

            this.map = L.map('map').setView(
                [this.mapCenter.lat, this.mapCenter.lng],
                this.mapCenter.zoom
            );

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(this.map);

            this.markerCluster = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
            });
            this.map.addLayer(this.markerCluster);

            // Debounced moveend â€” only updates job list, NOT markers
            this.map.on('moveend', () => {
                clearTimeout(this._moveendTimer);
                this._moveendTimer = setTimeout(() => {
                    const b = this.map.getBounds();
                    this.bounds = {
                        north: b.getNorth(),
                        south: b.getSouth(),
                        east: b.getEast(),
                        west: b.getWest()
                    };
                    this.syncToURL();
                    this.fetchJobs();
                }, 150);
            });

            // Load all markers once on init
            this.fetchMarkers();

            // If org was pre-selected from URL, show boundaries and highlight
            if (this.filters.organization_id) {
                const org = ALL_ORGS.find(o => o.id === this.filters.organization_id);
                if (org && org.tea_id) {
                    this.loadBoundariesThen(() => this.highlightDistrict(org.tea_id));
                }
            }
        },

        setMode(newMode) {
            if (this.mode === newMode) return;
            this.mode = newMode;
            this.syncToURL();

            if (newMode === 'map') {
                this.$nextTick(() => {
                    if (!this.map) {
                        this.initMap();
                    } else {
                        this.map.invalidateSize();
                        const b = this.map.getBounds();
                        this.bounds = {
                            north: b.getNorth(),
                            south: b.getSouth(),
                            east: b.getEast(),
                            west: b.getWest()
                        };
                        this.fetchJobs();
                    }
                });
            } else {
                this.fetchJobs();
            }
        },

        selectOrg(id, name, teaId) {
            this.filters.organization_id = id;
            this.selectedOrgName = name;
            this.orgSearchText = '';

            this.onFilterChange();

            // Boundary highlight
            if (id && teaId && this.mode === 'map') {
                this.loadBoundariesThen(() => this.highlightDistrict(teaId));
            } else {
                this.clearHighlight();
            }
        },

        onFilterChange() {
            this.syncToURL();
            this.fetchJobs();
            if (this.mode === 'map' && this.map) {
                this.fetchMarkers();
            }
        },

        clearFilters() {
            this.filters = { search: '', category: '', city: '', platform: '', organization_id: '' };
            this.selectedOrgName = '';
            this.orgSearchText = '';
            this.clearHighlight();
            this.onFilterChange();
        },

        // --- Boundary layer ---

        async loadBoundariesThen(callback) {
            if (this.boundaryData) {
                if (!this.boundariesVisible) this.showBoundaries();
                if (callback) callback();
                return;
            }

            try {
                const resp = await fetch('/data/boundaries/districts.geojson');
                if (!resp.ok) return;
                this.boundaryData = await resp.json();
                this.showBoundaries();
                if (callback) callback();
            } catch (e) {
                console.error('Failed to load boundaries:', e);
            }
        },

        toggleBoundaries() {
            if (this.boundariesVisible) {
                this.hideBoundaries();
            } else {
                this.loadBoundariesThen();
            }
        },

        showBoundaries() {
            if (this.boundaryLayer) {
                this.map.addLayer(this.boundaryLayer);
                this.boundariesVisible = true;
                return;
            }
            if (!this.boundaryData) return;

            const self = this;
            this.boundaryLayer = L.geoJSON(this.boundaryData, {
                style: function(feature) {
                    return {
                        color: '#6366f1',
                        weight: 1.5,
                        fillOpacity: 0.05,
                        fillColor: '#6366f1'
                    };
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    layer.bindTooltip(props.name || 'Unknown', { sticky: true, className: 'text-xs' });

                    layer.on('click', function() {
                        // Find the org matching this boundary's tea_id
                        const org = ALL_ORGS.find(o => o.tea_id === props.tea_id);
                        if (org) {
                            self.selectOrg(org.id, org.name, org.tea_id);
                        }
                    });
                }
            });
            this.boundaryLayer.addTo(this.map);
            this.boundariesVisible = true;
        },

        hideBoundaries() {
            if (this.boundaryLayer && this.map.hasLayer(this.boundaryLayer)) {
                this.map.removeLayer(this.boundaryLayer);
            }
            this.boundariesVisible = false;
        },

        highlightDistrict(teaId) {
            if (!this.boundaryLayer) return;

            // Reset all styles
            this.boundaryLayer.eachLayer(layer => {
                this.boundaryLayer.resetStyle(layer);
            });

            this._highlightedTeaId = teaId;

            // Find and highlight the matching feature
            this.boundaryLayer.eachLayer(layer => {
                if (layer.feature && layer.feature.properties.tea_id === teaId) {
                    layer.setStyle({
                        color: '#f59e0b',
                        weight: 3,
                        fillOpacity: 0.15,
                        fillColor: '#f59e0b'
                    });
                    layer.bringToFront();
                    // Zoom to the district bounds
                    this.map.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 12 });
                }
            });
        },

        clearHighlight() {
            this._highlightedTeaId = null;
            if (this.boundaryLayer) {
                this.boundaryLayer.eachLayer(layer => {
                    this.boundaryLayer.resetStyle(layer);
                });
            }
        },

        // --- Job fetching ---

        buildQueryParams(extra) {
            const p = new URLSearchParams();
            p.set('mode', this.mode);
            if (this.filters.search) p.set('search', this.filters.search);
            if (this.filters.category) p.set('category', this.filters.category);
            if (this.filters.city) p.set('city', this.filters.city);
            if (this.filters.platform) p.set('platform', this.filters.platform);
            if (this.filters.organization_id) p.set('organization_id', this.filters.organization_id);

            if (this.mode === 'map' && this.bounds) {
                p.set('north', this.bounds.north.toFixed(6));
                p.set('south', this.bounds.south.toFixed(6));
                p.set('east', this.bounds.east.toFixed(6));
                p.set('west', this.bounds.west.toFixed(6));
            }

            if (extra) {
                Object.entries(extra).forEach(([k, v]) => p.set(k, v));
            }
            return p.toString();
        },

        fetchJobs() {
            this.loading = true;
            const qs = this.buildQueryParams({ page: 1 });
            htmx.ajax('GET', `/jobs/partial?${qs}`, {
                target: '#job-list-content',
                swap: 'innerHTML'
            }).then(() => {
                this.loading = false;
            });
        },

        async fetchMarkers() {
            const key = this._currentFilterKey();
            if (key === this.markersFilterKey) return;

            this.fetchId++;
            const currentId = this.fetchId;
            this.markersLoading = true;

            const p = new URLSearchParams();
            if (this.filters.search) p.set('search', this.filters.search);
            if (this.filters.category) p.set('category', this.filters.category);
            if (this.filters.city) p.set('city', this.filters.city);
            if (this.filters.platform) p.set('platform', this.filters.platform);
            if (this.filters.organization_id) p.set('organization_id', this.filters.organization_id);

            try {
                const resp = await fetch(`/api/v1/geo/jobs/markers?${p.toString()}`);
                if (currentId !== this.fetchId) return;
                const data = await resp.json();

                this.markerCluster.clearLayers();
                this.popupCache.clear();

                const markers = [];
                for (const m of data.markers) {
                    const marker = L.marker([m[0], m[1]]);
                    marker._jobId = m[2];
                    marker.bindPopup('<div class="flex justify-center py-2"><span class="loading loading-spinner loading-xs"></span></div>');
                    marker.on('click', () => this._loadPopup(marker));
                    markers.push(marker);
                }
                this.markerCluster.addLayers(markers);

                this.markersFilterKey = key;
                this.totalCount = data.total;
            } catch (e) {
                console.error('Failed to load markers:', e);
            } finally {
                if (currentId === this.fetchId) {
                    this.markersLoading = false;
                }
            }
        },

        async _loadPopup(marker) {
            const jobId = marker._jobId;

            if (this.popupCache.has(jobId)) {
                marker.setPopupContent(this._buildPopupHtml(this.popupCache.get(jobId)));
                return;
            }

            try {
                const resp = await fetch(`/api/v1/geo/jobs/${jobId}/popup`);
                if (!resp.ok) throw new Error('Not found');
                const data = await resp.json();
                this.popupCache.set(jobId, data);
                marker.setPopupContent(this._buildPopupHtml(data));
            } catch (e) {
                marker.setPopupContent('<div class="text-xs text-error">Could not load details</div>');
            }
        },

        _buildPopupHtml(data) {
            return `
                <div>
                    <div class="job-popup-title">${this.escapeHtml(data.title)}</div>
                    <div class="job-popup-org">${this.escapeHtml(data.organization)}</div>
                    <div class="job-popup-meta">
                        ${data.category ? `<span class="job-popup-badge">${this.escapeHtml(data.category)}</span>` : ''}
                        ${data.city ? `<span class="job-popup-badge">${this.escapeHtml(data.city)}</span>` : ''}
                    </div>
                    <a href="${this.escapeHtml(data.detail_url)}" class="job-popup-link">View Details</a>
                </div>
            `;
        },

        onJobsLoaded(detail) {
            if (detail.shown !== undefined) this.shownCount = detail.shown;
            if (detail.total !== undefined) this.totalCount = detail.total;
        },

        locateMe() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            this.locating = true;
            navigator.geolocation.getCurrentPosition(
                pos => {
                    this.locating = false;
                    if (this.mode !== 'map') this.setMode('map');
                    this.$nextTick(() => {
                        if (this.map) this.map.flyTo([pos.coords.latitude, pos.coords.longitude], 11);
                    });
                },
                () => {
                    this.locating = false;
                    alert('Unable to get your location. Please enable location services.');
                }
            );
        },

        escapeHtml(text) {
            if (!text) return '';
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }
    };
}
</script>
{% endblock %}
