{% extends "base.html" %}

{% block title %}Job Map - Texas Ed Jobs{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
    #map {
        height: calc(100vh - 12rem);
        width: 100%;
        border-radius: 0.5rem;
    }
    .leaflet-popup-content {
        min-width: 200px;
        max-width: 300px;
    }
    .job-popup-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    .job-popup-org {
        color: #4b5563;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }
    .job-popup-location {
        color: #6b7280;
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
    }
    .job-popup-link {
        display: inline-block;
        background: #2563eb;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        text-decoration: none;
        font-size: 0.875rem;
    }
    .job-popup-link:hover {
        background: #1d4ed8;
    }
    .marker-cluster-small {
        background-color: rgba(110, 204, 57, 0.6);
    }
    .marker-cluster-small div {
        background-color: rgba(110, 204, 57, 0.9);
    }
    .marker-cluster-medium {
        background-color: rgba(240, 194, 12, 0.6);
    }
    .marker-cluster-medium div {
        background-color: rgba(240, 194, 12, 0.9);
    }
    .marker-cluster-large {
        background-color: rgba(241, 128, 23, 0.6);
    }
    .marker-cluster-large div {
        background-color: rgba(241, 128, 23, 0.9);
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Job Locations</h1>
        <p class="text-gray-600 mt-1">
            {{ geocoded_count }} jobs with location data
        </p>
    </div>
    <div class="flex gap-2">
        <a href="/jobs" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium">
            List View
        </a>
        <button id="locate-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
            Near Me
        </button>
    </div>
</div>

<div class="flex gap-4">
    <!-- Map container -->
    <div class="flex-1">
        <div id="map" class="shadow-lg"></div>
    </div>

    <!-- Sidebar -->
    <div class="w-64 bg-white rounded-lg shadow-lg p-4 hidden lg:block">
        <h2 class="font-semibold text-gray-900 mb-3">Top Cities</h2>
        <ul class="space-y-2">
            {% for city, count in top_cities %}
            <li class="flex justify-between items-center text-sm">
                <button class="text-blue-600 hover:text-blue-800 text-left" onclick="flyToCity('{{ city }}')">
                    {{ city }}
                </button>
                <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs">
                    {{ count }}
                </span>
            </li>
            {% endfor %}
        </ul>

        <hr class="my-4">

        <h2 class="font-semibold text-gray-900 mb-3">Search Location</h2>
        <form id="location-search" class="space-y-2">
            <input
                type="text"
                id="location-input"
                placeholder="City, ZIP, or address"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
            <div class="flex gap-2">
                <select id="radius-select" class="flex-1 border border-gray-300 rounded-lg px-2 py-2 text-sm">
                    <option value="10">10 miles</option>
                    <option value="25" selected>25 miles</option>
                    <option value="50">50 miles</option>
                    <option value="100">100 miles</option>
                </select>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                    Search
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
// Texas center coordinates
const TEXAS_CENTER = [31.0, -100.0];
const TEXAS_BOUNDS = [[25.8, -106.6], [36.5, -93.5]];

// Major Texas cities for quick navigation
const CITIES = {
    'Houston': [29.7604, -95.3698],
    'Dallas': [32.7767, -96.7970],
    'San Antonio': [29.4241, -98.4936],
    'Austin': [30.2672, -97.7431],
    'Fort Worth': [32.7555, -97.3308],
    'El Paso': [31.7619, -106.4850],
    'Corpus Christi': [27.8006, -97.3964],
    'Lubbock': [33.5779, -101.8552],
};

// Initialize map
const map = L.map('map').setView(TEXAS_CENTER, 6);

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

// Create marker cluster group
const markers = L.markerClusterGroup({
    chunkedLoading: true,
    maxClusterRadius: 50,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
});

// Load jobs from GeoJSON API
async function loadJobs() {
    try {
        const response = await fetch('/api/v1/geo/jobs/geojson?limit=2000');
        const data = await response.json();

        if (data.features) {
            data.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;

                const marker = L.marker([coords[1], coords[0]]);
                marker.bindPopup(`
                    <div class="job-popup">
                        <div class="job-popup-title">${props.title}</div>
                        <div class="job-popup-org">${props.organization}</div>
                        <div class="job-popup-location">${props.city || ''}, ${props.state || 'TX'}</div>
                        <a href="${props.url}" target="_blank" rel="noopener" class="job-popup-link">
                            Apply
                        </a>
                    </div>
                `);
                markers.addLayer(marker);
            });

            map.addLayer(markers);
            console.log(`Loaded ${data.features.length} job markers`);
        }
    } catch (error) {
        console.error('Failed to load jobs:', error);
    }
}

// Fly to city
function flyToCity(cityName) {
    const coords = CITIES[cityName];
    if (coords) {
        map.flyTo(coords, 11);
    } else {
        // Try geocoding
        fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)},Texas&format=json&limit=1`)
            .then(r => r.json())
            .then(results => {
                if (results.length > 0) {
                    map.flyTo([results[0].lat, results[0].lon], 11);
                }
            });
    }
}

// Locate user
document.getElementById('locate-btn').addEventListener('click', () => {
    if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                map.flyTo([pos.coords.latitude, pos.coords.longitude], 11);
            },
            err => {
                alert('Unable to get your location. Please enable location services.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
});

// Location search form
document.getElementById('location-search').addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = document.getElementById('location-input').value;
    const radius = document.getElementById('radius-select').value;

    if (!input) return;

    // Check if it's a ZIP code (5 digits)
    if (/^\d{5}$/.test(input)) {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${input}&country=US&format=json&limit=1`);
        const results = await response.json();
        if (results.length > 0) {
            map.flyTo([results[0].lat, results[0].lon], getZoomForRadius(radius));
        } else {
            alert('ZIP code not found');
        }
    } else {
        // Geocode address
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(input)},Texas&format=json&limit=1`);
        const results = await response.json();
        if (results.length > 0) {
            map.flyTo([results[0].lat, results[0].lon], getZoomForRadius(radius));
        } else {
            alert('Location not found');
        }
    }
});

function getZoomForRadius(miles) {
    if (miles <= 10) return 12;
    if (miles <= 25) return 10;
    if (miles <= 50) return 9;
    return 8;
}

// Load jobs on page load
loadJobs();
</script>
{% endblock %}
